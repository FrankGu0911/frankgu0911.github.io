<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>基于多模态语言模型的低延迟端到端自动驾驶模型</title>
      <link href="/2024/05/03/paper2/"/>
      <url>/2024/05/03/paper2/</url>
      
        <content type="html"><![CDATA[<h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p>随着人工智能技术的快速发展，自动驾驶技术已经成为了当下科技领域最具活力和前瞻性的研究热点之一。在自动驾驶领域，基于模仿学习的端到端模型因其简单的结构与复杂场景下强大的泛化性能而受到关注。受限于其原理，模仿学习的输出往往难以达到或超越直接模仿的专家系统的水平。因此，模仿学习的数据集的质量对模型的性能有着至关重要的影响。</p><p>目前被广泛使用的专家数据包括基于规则的专家算法采集的数据、基于强化学习的专家算法采集的数据以及人类驾驶专家采集的数据。基于规则的专家算法则需详尽定义各类规则，违背了端到端模型简洁的设计初衷，且限制了端到端算法在复杂场景下的泛化性能；基于强化学习的专家算法虽然在决策能力上表现出色，但其生成的策略与人类驾驶习惯差异显著。相比之下，使用人类专家的驾驶数据进行学习可以有效避免上述问题，其驾驶习惯与人类相符，无需编写具体规则，且在复杂场景中展示出较好的泛化能力，从而显著提升模型的实际应用价值。然而，这种方法通常缺乏决策过程的可解释性，且人类行为存在个体差异，决策具有一定的不一致性，从而引起安全顾虑和法律问题，甚至危及乘客和行人的安全。</p><p>近年来，随着多模态大型语言模型的发展，使得通用人工智能领域取得了显著进展。这些模型在包括自动驾驶在内的多个领域展现出优秀的性能，并且具备较高的可解释性。然而，大语言模型在实时推理任务中表现出较慢的处理速度和较低的实时性，在需要即时响应的应用场景中难以直接使用。</p><p>综上所述，人类驾驶数据集在可解释性和决策一致性方面仍存在不足。尽管多模态大型语言模型在可解释性方面表现优异且能有效识别决策的不一致性，但其在自动驾驶领域的直接应用仍受限于处理速度慢和实时性低的显著缺点。因此，在自动驾驶领域中的可解释性和实时性之间的权衡问题亟待解决。</p><p>鉴于此，本研究针对基于模仿学习的端到端算法，在数据标注与决策算法上展开研究。本文的主要贡献如下：</p><ol><li>针对端到端模型在学习人类驾驶数据集过程中可解释性不足的问题，提出了一种利用多模态大语言模型对自动驾驶数据集进行决策原因和关键物体的标注方法，并通过多任务学习决策原因和关键目标，为决策过程提供直观解释的同时，提高模型的性能；</li><li>针对大语言模型在自动驾驶中直接推理时实时性较低的问题，提出了在数据集处理中使用大语言模型对驾驶数据进行详尽的标注，避免了实时推理阶段的延迟，从而在保证实时性的情况下增加了可解释性。</li></ol><h1 id="相关工作"><a href="#相关工作" class="headerlink" title="相关工作"></a>相关工作</h1><p>随着现代人工智能技术的快速发展，端到端学习方法已广泛应用于汽车自动驾驶技术中。与难以收敛且与人类驾驶习惯有显著差异的强化学习（Reinforcement Learning, RL）相比，模仿学习（Imitation Learning, IL）[1,2]通过直接利用专家数据进行监督学习，不需要像强化学习那样从头开始探索。这种方法不仅收敛速度快，而且可以获得较为稳定和可预测的行为输出。</p><p>随着自动驾驶模仿学习的发展，方法从最初的直接模仿动作，逐步过渡到更复杂的轨迹模仿和多任务学习。文献（CIL）使用自车元信息、高级指令与图像编码器，对控制动作进行直接预测。在此基础上，文献（CILRS）随后被提出，进一步引入了目标速度预测。然而，这种基于直接控制的方法通常具有更高的车辆碰撞率。文献Transfuser及其变体使用一个简单的GRU来自回归预测行驶路径点，有效降低了碰撞率。文献LAV在此基础上采用时序GRU模块来进一步细化轨迹。这些基于轨迹的方法都使用PID控制器来获得最终动作，这使得在复杂情景中可能导致效果不佳。文献TCP提出了一种融合控制动作与路径规划的方法，结合两种输出形式的优点，进一步提升在不同场景下的表现。文献Interfuser则通过多任务学习将安全相关输出与路径规划输出分离，进一步提升了模型的性能同时，提高了模型的可解释性。文献LCDiff则进一步引入了BEV预测模块，提升了模型在复杂场景下的泛化性能。</p><p>在模仿学习中，选择正确的数据集对于算法的性能和可行性至关重要。文献（TCP，Roach）使用了具有全局信息的强化学习专家行驶数据作为数据集进行训练，展示了在处理复杂交通环境时的高效性能，然而其生成的策略与人类驾驶习惯差异显著，在一些复杂情况下通常会做出一些不可解释的危险行为。<br>文献（Interfuser，Transfuser，TF++WP）使用了规则专家的驾驶数据作为数据集进行训练，证明了这种方法在保持行为一致性和规则遵循方面的有效性。尽管如此，这种方法通常缺乏应对未预见情况的灵活性。使用人类专家的驾驶数据进行学习可以提高模型的实际应用价值，但人类行为的个体差异和决策不一致性使得作为数据集时，模型训练出来的结果往往缺乏可解释性。</p><p>近年来多模态大语言模型等通用人工智能技术发展迅速，研究者开始探索将这些先进模型应用于自动驾驶的可能性。文献LMDrive使用自然语言指令作为输入，结合多传感器数据，通过多模态大语言模型生成驾驶决策，在输出轨迹与控制动作的同时，提供了决策原因的解释，增强了模型的可解释性和透明度。然而，大语言模型在实时推理任务中表现出较慢的处理速度和较低的实时性，在真实驾驶场景中难以直接使用。文献DriveVLM提出了一种双系统快慢机制，通过使用传统的端到端模型进行快速推理，再通过大语言模型进行慢速推理，一定程度上缓解了实时性问题，提高了系统的响应速度和实用性。尽管有所改进，这种双系统机制在处理高度动态和复杂的驾驶场景时仍显示出性能和实时性的局限，特别是在需要同时考虑多个突发因素和紧急响应的情况下。</p><h1 id="方法与实现"><a href="#方法与实现" class="headerlink" title="方法与实现"></a>方法与实现</h1><p>本文提出了一种新颖的基于多任务学习的端到端自动驾驶模型，并结合了多模态大语言模型来标注人类驾驶数据集中的决策原因和关键物体，以提高模型的性能和可解释性。本方法主要包括多模态大语言模型标注与多任务模仿学习两个部分。如图1所示，本模型在训练前，先通过多模态大语言模型对人类驾驶数据集进行全面的标注。针对包含刹车、大幅转向等关键驾驶行为的数据帧X_t，使用X_(t-3)到X_t的连续帧中的图像、雷达、交通参与者信息与控制作为输入，得出驾驶意图I_t与关键物体O_t的标注。在训练与推理阶段，将多模态信息输入感知编码器得到融合特征$F_t$，将$F_t$输入到决策模型中，在预测航点$W_t$-$W_{t+3}$的同时，预测所需驾驶意图$I_t$与关键物体$O_t$，以多任务输出的方式提高模型的性能与可解释性。通过预测的航点$W_t$-$W_{t+3}$与当前速度$V_t$、当前方向角$\theta_t$，分别对速度与方向角进行PID控制，得出最终的控制动作预测：转向$\delta_t$、油门$T_t$与刹车$B_t$。<br><img src="/images/paper2/%E5%9B%BE1.png" alt="图1. 模型结构"></p><h2 id="自动驾驶模型建模"><a href="#自动驾驶模型建模" class="headerlink" title="自动驾驶模型建模"></a>自动驾驶模型建模</h2><p>自动驾驶模型的目标是在复杂的城市环境中，在各种交通状况、道路类型和不可预测元素（如行人过街和各类天气）的情况下，使车辆能够自主、安全、高效地行驶。模型从起点A行驶至终点B，通过全球导航卫星系统（GNSS）坐标$TP_0$至$TP_n$指引路径。在行驶中的每个时刻t，车辆可以获得当前位置$P_t$、当前速度$V_t$、当前方向角$\theta_t$，并根据不同的传感器配置，可以获得图像数据$I_t$、激光雷达数据$L_t$等多模态信息。基于这些输入，端到端自动驾驶模型$Model(.)$的任务是输出车辆的控制动作，基础模型设计如下：<br>$$\delta_t, T_t, B_t &#x3D; Model(TP_{0-n}, P_{0-t}, V_{0-t}, \theta_{0-t}, I_{0-t}, L_{0-t})$$<br>其中，$\delta_t$、$T_t$、$B_t$分别表示车辆在时刻t的转向、油门和刹车控制动作。$Model(.)$表示一个端到端的自动驾驶模型，输入为导航点、车辆位置、速度、方向角、图像和激光雷达数据，输出为车辆的控制动作。自动驾驶模型的任务就是通过处理这些多模态输入，解读复杂的环境信息，并在不违反交通规则的前提下，做出合理的决策，以实现车辆的自主行驶。</p><p>此外，为了使模型能够充分理解驾驶环境，本研究设计了一个多任务学习框架，以提高模型的性能和可解释性。驾驶意图$I_t$与关键物体$O_t$被设定为多任务学习的目标，同时环境感知任务，例如BEV特征$BEV_t$，也被列为多任务学习目标。总体的模型设计如下：<br>$$\delta_t, T_t, B_t, I_t, O_t, BEV_t &#x3D; Model(TP_{0-n}, P_{0-t}, V_{0-t}, \theta_{0-t}, I_{0-t}, L_{0-t})$$</p><h2 id="数据采集与多模态大语言模型标注"><a href="#数据采集与多模态大语言模型标注" class="headerlink" title="数据采集与多模态大语言模型标注"></a>数据采集与多模态大语言模型标注</h2><p>为了支撑这些多任务学习目标，本研究需要一个精确标注的数据集。因此，在端到端自动驾驶领域被广泛采用的CARLA[]模拟器被选为数据采集工具，该模拟器能够提供一个逼真的动态闭环世界。数据收集包括两个阶段：</p><ol><li>人类专家在CARLA中根据导航点驾驶，并收集传感器数据和控制信号；</li><li>使用多模态大语言模型对包含刹车、大幅转向等关键驾驶行为的数据进行驾驶意图与关键物体的标注。</li></ol><p>人类专家在CARLA模拟器中进行人工驾驶，并以2Hz的频率进行数据采集，共采集了2.2万帧的驾驶数据。每一帧数据包括了车辆的当前位置、速度、方向角、导航点、图像和激光雷达的传感器数据，油门、刹车与转向的控制动作，以及附近交通参与者位置与BEV特征的高级信息。为了增强收集数据集的多样性，采集过程共使用了14种天气，涵盖了早晨、中午、傍晚等不同时间段，以及晴天、阴天、雨天等不同天气条件。传感器配置上使用了三个RGB摄像头（左、前、右）和一个激光雷达，侧面摄像头的角度为60°。为了验证模型的泛化能力，LAV[]路线中的Town02与Town05在采集过程中被有意避免，并被设置为测试场景。</p><p>本研究通过对数据集进行详细标注来提高模型的性能和解释性。针对包含刹车、大幅转向等关键驾驶行为的数据帧，需要对其进行驾驶意图与关键物体的标注。为了实现这一目标，本研究使用了多模态大语言模型对数据集进行标注。整体流程如图2所示，首先将连续的四帧的的图像序列作为输入，并通过文本的方式输入当前帧的控制信息，得到驾驶意图输出与其对应描述。驾驶意图被分为17类，包括但不限于加速、减速、转向、变道、绕行、轻微位置调整和等待。在得到驾驶意图后，继续通过多模态大语言模型的上下文记忆能力，标注出影响决策的关键物体。关键物体被定义为在当前帧中对驾驶意图产生重要影响的物体，如前方车辆、行人、交通标志、信号灯等。由于大语言模型对数值计算的支持较弱，本研究通过输入当前帧的交通参与者相对位置信息的方式，让大语言模型通过选择而非计算来标注出关键物体。<br><img src="/images/paper2/%E5%9B%BE2.png" alt="图2. 标注"></p><h2 id="多任务学习框架"><a href="#多任务学习框架" class="headerlink" title="多任务学习框架"></a>多任务学习框架</h2><p>为了提高模型的性能和可解释性的同时，保证模型的实时性，本研究设计了一个多任务学习框架，该框架针对由大语言模型完成标注的驾驶意图与关键物体进行学习。主任务设置为直接影响驾驶行为的航点预测任务，而辅助任务包括环境感知任务、驾驶意图预测以及关键物体预测。这些辅助任务旨在促进模型对驾驶环境的理解，从而提高模型的性能，同时提供直观的决策解释。</p><p>如图3所示，多任务学习的目标包括环境感知任务、航点预测、驾驶意图预测和关键物体预测。为了避免[TF++]中提出的捷径问题，并确保车辆始终保持在车道线内，该框架使用了一个标准的Transformer解码器来处理感知特征$F_t$。一部分经处理的嵌入特征被输入到门控循环网络（GRU）中，以预测未来航点的位置$W_t$-$W_{t+3}$。与此同时，另一部分嵌入特征被输入到安全解释器中，用于预测驾驶意图$I_t$与关键物体$O_t$。在感知任务中，感知解码器根据感知特征$F_t$对BEV特征$BEV_t$进行预测。</p><p>预测的航点$W_t$到$W_{t+3}$，结合当前速度$V_t$和方向角$\theta_t$，被进一步处理以输出对车辆的控制值。这些数据输入到两个独立的PID控制器，分别调节速度和方向，输出最终的控制动作预测：转向$\delta_t$、油门$T_t$与刹车$B_t$。<br><img src="/images/paper2/%E5%9B%BE3.png" alt="图3. 多任务学习"></p><!-- ## 实施细节 --><h1 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h1><h2 id="评估指标"><a href="#评估指标" class="headerlink" title="评估指标"></a>评估指标</h2><p>在自动驾驶任务中，由于对模型的评估不能依赖简单的准确率或偏离率指标，因此，本研究采用了Carla模拟器来进行闭环模拟驾驶。为了测试自动驾驶系统的稳健性和反应能力，设计了一系列复杂的城市环境，包括多车道道路、复杂的路口、以及偶尔出现的突发交通状况。模型的评估采用了几个关键的指标：路线完成度（Route Completion，RC），该指标衡量车辆成功完成路线的百分比；违规分数（Infraction Score，IS），该指标随着车辆违反交通规则的次数增加而降低；综合驾驶分数（Driving Score，DS），即RC与IS的乘积，用于综合评价模型的性能。这些指标涵盖了模型完成路线的能力与遵守交通规则的表现，是Carla闭环模拟中评价自动驾驶模型性能的重要指标。</p><h2 id="实验设置"><a href="#实验设置" class="headerlink" title="实验设置"></a>实验设置</h2><p>实验环境使用0.9.10.1版本的Carla模拟器，并使用Carla leaderboard来评估模型的性能。模型在两组不同的路线与14种天气条件上进行测试，包括Longest6[]路线与LAV[]路线。其中Longest6路线所涉及的城镇在训练时被使用，而LAV路线的城镇则未在训练中使用，以验证模型的泛化能力。</p><p>感知编码器上，我们分别使用了LCDiff所提出的BEV感知模型和Transfuser的感知模块，以验证本研究提出的多任务学习框架的性能。LCDiff使用了扩散模型，并使用LiDar数据通过ControlNet结构来引导BEV的生成，从而能够输出高精度的BEV特征。Transfuser的感知模块使用Transformer在不同尺度上对图像与LiDar进行融合，并采用自注意力机制来增强全局环境理解。</p><h2 id="模型性能对比"><a href="#模型性能对比" class="headerlink" title="模型性能对比"></a>模型性能对比</h2><p>在LCDiff和Transfuser外，本研究的多任务学习框架还与其他几个最先进的自动驾驶模型进行了比较，包括LAV与Interfuser。LAV通过使用模型能观测到的所有车辆的数据来进行数据增强，从而提高了模型的泛化能力。Interfuser通过多任务学习将安全相关输出与路径规划输出分离，进一步提升了模型的性能。值得注意的是，被比较的模型均使用了规则专家或强化学习专家的驾驶数据集进行训练，而本研究的模型则使用了人类专家的驾驶数据集经过多模态大语言模型标注后进行训练。</p><p>表1. 在Longest6路线上的实验结果*</p><table><thead><tr><th>方法</th><th>DS↑</th><th>RC↑</th><th>IS↑</th></tr></thead><tbody><tr><td>LAV</td><td>58.3±1.1</td><td>83.2±1.3</td><td>0.68±0.02</td></tr><tr><td>Interfuser</td><td>46.8±5.6</td><td>74.3±1.0</td><td>0.63±0.07</td></tr><tr><td>Transfuser</td><td>46.6±6.2</td><td>92.9±1.2</td><td>0.50±0.06</td></tr><tr><td>LCDiff</td><td>53.3±2.6</td><td>94.9±0.7</td><td>0.56±0.02</td></tr><tr><td>Ours(Transfuer-based)</td><td>52.7±2.7</td><td>95.6±1.5</td><td>0.55±0.02</td></tr><tr><td>Ours(LCDiff-based)</td><td>64.3±2.5</td><td>97.6±0.9</td><td>0.66±0.02</td></tr></tbody></table><p>*3次实验的平均值与标准差</p><p>从表1中可以看出，本研究提出的多任务学习框架在训练城镇Longest6路线上的表现优于其他几个最先进的自动驾驶模型。以Transfuser为感知模块的多任务学习框架在DS、RC和IS上比原模型提高了13.1%、2.9%和10.0%，而以LCDiff为感知模块的多任务学习框架在DS、RC和IS上则比原模型提高了14.8%、2.8%和12.1%。这表明本研究提出的辅助任务驾驶意图预测与关键物体预测，能够有效提高模型遵守交通规则的能力，同时也增强了模型在复杂环境下的导航准确性。在使用LCDiff感知模块的框架中，得益于高精度BEV特征作为辅助任务，模型在IS上取得了很大的提升。</p><p>表2. 在LAV路线上的实验结果*</p><table><thead><tr><th>方法</th><th>DS↑</th><th>RC↑</th><th>IS↑</th></tr></thead><tbody><tr><td>LAV</td><td>60.4±2.5</td><td>94.5±1.1</td><td>0.64±0.02</td></tr><tr><td>Interfuser</td><td>38.2±1.5</td><td>62.7±3.6</td><td>0.61±0.04</td></tr><tr><td>Transfuser</td><td>39.1±9.2</td><td>84.2±6.8</td><td>0.46±0.06</td></tr><tr><td>LCDiff</td><td>55.6±3.0</td><td>98.1±1.0</td><td>0.57±0.03</td></tr><tr><td>Ours(Transfuer-based)</td><td>50.3±2.2</td><td>85.9±2.0</td><td>0.59±0.02</td></tr><tr><td>Ours(LCDiff-based)</td><td>63.9±3.1</td><td>98.4±0.6</td><td>0.65±0.03</td></tr></tbody></table><p>*3次实验的平均值与标准差</p><p>从表2中可以看出，本研究提出的多任务学习框架在未见过的验证城镇LAV路线上同样表现出色。基于Transfuser的变体在DS、RC和IS上比原模型提高了28.6%、2.0%和28.3%，而基于LCDiff的变体在DS、RC和IS上则比原模型提高了14.9%、0.4%和14.0%。由于LAV路线的城镇未在训练中使用，Transfuser的基础模型在IS上表现较差，比较容易违反交通规则，而本研究提出的多任务学习框架使其在IS上取得了很大的提升。在使用LCDiff感知模块的框架中，由于其泛化能力较Transfuser更强，基础模型已有较高的RC，然而在IS上，多任务学习框架的引入仍然使其取得了进一步的提升。</p><p>针对自动驾驶模型的实时性，本研究在不同模型上进行了推理时间的对比。实验环境中，CPU为AMD Ryzen 9 7950x， GPU为NVIDIA RTX 3090，内存为64GB，实验系统为Ubuntu 22.04。实验路线选用了Longest6路线，实验取每一帧的平均推理时间作为对比指标。除了Transfuser和LCDiff外，LMDrive[]作为直接使用多模态大语言模型的代表也被选为对比对象，使用了其提供的基于LLaVA-v1.5-7B微调的模型。实验结果如表3所示。</p><p>表3. 单帧平均推理时长</p><table><thead><tr><th>方法</th><th>推理时长(ms)↓</th><th>DS↑</th><th>RC↑</th><th>IS↑</th></tr></thead><tbody><tr><td>Transfuser</td><td>44ms</td><td>46.6</td><td>92.9</td><td>0.50</td></tr><tr><td>LCDiff</td><td>159ms</td><td>53.3</td><td>94.9</td><td>0.56</td></tr><tr><td>LMDrive</td><td>1769ms</td><td>44.5</td><td>51.1</td><td>0.87</td></tr><tr><td>Ours(Transfuer-based)</td><td>47ms</td><td>52.7</td><td>95.6</td><td>0.55</td></tr><tr><td>Ours(LCDiff-based)</td><td>166ms</td><td>64.3</td><td>97.6</td><td>0.66</td></tr></tbody></table><p>从表3中可以看出，本研究提出的多任务学习框架在推理时间上对比基础模型Transfuser和LCDiff相当，且在性能上均有所提升。LCDiff的推理时间较长，主要是因为高精度BEV特征的生成与其扩散模型的架构限制。对比起直接使用多模态大语言模型的LMDrive，多任务学习框架在推理时间上有较大的优势。值得注意的是，LMDrive在路线完成度（RC）上表现不佳，主要原因在于该模型使用大语言模型直接进行数值预测，这种方法在处理具体的导航任务时可能不如基于回归的方法精确。然而，在违规分数IS上，LMDrive的表现较好，其遵守交通规则的能力明显优于其他模型，这表明大语言模型在预见潜在违规行为方面具有很大的优势。</p><h2 id="消融实验"><a href="#消融实验" class="headerlink" title="消融实验"></a>消融实验</h2><p>针对基于模仿学习的端到端自动驾驶模型，数据集的选择对模型训练和性能具有重要影响。为了深入研究这一影响，本研究进行了消融实验，通过比较规则专家数据集与人类专家数据集对模型的影响，探讨了这些数据集在模仿学习中的作用及其对模型性能的具体影响。针对规则专家数据集，其标签中的驾驶意图与关键物体是由专家算法经过分支判断后得出的，而人类专家数据集则是由人类专家驾驶员在CARLA模拟器中进行人工驾驶后得到的，其驾驶意图与关键物体的标注则是通过多模态大语言模型完成的。</p><table><thead><tr><th>方法</th><th>数据集</th><th>多任务学习</th><th>DS↑</th><th>RC↑</th><th>IS↑</th></tr></thead><tbody><tr><td>Our(Transfuer-based)</td><td>规则专家</td><td>×</td><td></td><td></td><td></td></tr><tr><td>Our(Transfuer-based)</td><td>人类专家</td><td>×</td><td></td><td></td><td></td></tr><tr><td>Our(Transfuer-based)</td><td>规则专家</td><td>√</td><td></td><td></td><td></td></tr><tr><td>Our(Transfuer-based)</td><td>人类专家</td><td>√</td><td></td><td></td><td></td></tr><tr><td>Our(LCDiff-based)</td><td>规则专家</td><td>×</td><td></td><td></td><td></td></tr><tr><td>Our(LCDiff-based)</td><td>人类专家</td><td>×</td><td></td><td></td><td></td></tr><tr><td>Our(LCDiff-based)</td><td>规则专家</td><td>√</td><td></td><td></td><td></td></tr><tr><td>Our(LCDiff-based)</td><td>人类专家</td><td>√</td><td></td><td></td><td></td></tr></tbody></table><p>从表4中可以看出，无论是基于Transfuser还是LCDiff的多任务学习框架，使用人类专家数据集进行训练均优于使用规则专家数据集。这表明人类专家数据集在模仿学习中具有更高的价值。</p><table><thead><tr><th>方法</th><th>驾驶意图</th><th>关键物体</th><th>DS↑</th><th>RC↑</th><th>IS↑</th></tr></thead><tbody><tr><td>Our(Transfuer-based)</td><td>×</td><td>×</td><td></td><td></td><td></td></tr><tr><td>Our(Transfuer-based)</td><td>×</td><td>√</td><td></td><td></td><td></td></tr><tr><td>Our(Transfuer-based)</td><td>√</td><td>×</td><td></td><td></td><td></td></tr><tr><td>Our(Transfuer-based)</td><td>√</td><td>√</td><td></td><td></td><td></td></tr><tr><td>Our(LCDiff-based)</td><td>×</td><td>×</td><td></td><td></td><td></td></tr><tr><td>Our(LCDiff-based)</td><td>×</td><td>√</td><td></td><td></td><td></td></tr><tr><td>Our(LCDiff-based)</td><td>√</td><td>×</td><td></td><td></td><td></td></tr><tr><td>Our(LCDiff-based)</td><td>√</td><td>√</td><td></td><td></td><td></td></tr></tbody></table><h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p>[1] POMERLEAU D A.ALVINN:an autonomous land vehicle in a neural network[C]&#x2F;Proceedings of the 1st International Conference on Neural Information Processing Systems.Cambridge,MA,USA:[s.n.],1988:305-313.</p><p>[2] BOJARSKI M,DELTESTA D,DWORAKOWSKI D,et al.End to End Learning for Self-Driving Cars[EB&#x2F;OL].(2016-04-25) [2022-12-20].<a href="http://arxiv.org/abs/1604.07316">http://arxiv.org/abs/1604.07316</a>.</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>如何使用Quest3录制3D视频</title>
      <link href="/2024/04/17/Quest-3D-video/"/>
      <url>/2024/04/17/Quest-3D-video/</url>
      
        <content type="html"><![CDATA[<p>笔者为了提高生产力（买后爱奇艺），把VR当做多屏显示器使用，顺便欣赏一下3D视频中的奇异世界（小姐姐），在日亚花了39伯大洋买了一个Quest3，（现在发现拼多多更便宜，我是傻逼）。然而，我发现了一个问题，Quest3的录制功能只能录制2D视频，设置选项中只有选录左眼视角还是右眼视角，没有3D选项。那么，如何使用Quest3录制3D视频呢？</p><h2 id="1-开启开发者模式"><a href="#1-开启开发者模式" class="headerlink" title="1. 开启开发者模式"></a>1. 开启开发者模式</h2><p>虽然Quest3这台设备是安卓系统，但是它的开发者模式并不是那么容易开启的，需要在<a href="https://developer.oculus.com/">Meta开发者网站</a>注册开发者账号，注册后，导航到你的Meta Quest app。在设备找到你的Quest 3，进入头显设置，并启用开发者模式。这样，你的Quest 3就可以使用ADB连接到电脑上了。</p><h2 id="2-使用ADB连接到电脑"><a href="#2-使用ADB连接到电脑" class="headerlink" title="2. 使用ADB连接到电脑"></a>2. 使用ADB连接到电脑</h2><p>先去下载ADB工具，并配置环境变量（或到ADB的目录下），再用USB线连接电脑和Quest 3，然后在终端输入以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb devices<br></code></pre></td></tr></table></figure><p>如果出现设备号，说明连接成功。</p><h2 id="3-使用ADB命令配置录制参数"><a href="#3-使用ADB命令配置录制参数" class="headerlink" title="3. 使用ADB命令配置录制参数"></a>3. 使用ADB命令配置录制参数</h2><p>Quest 3的录制参数是通过ADB命令设置的，在终端输入以下命令，设置录制参数：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">adb shell setprop debug.oculus.screenCaptureEye 2 <span class="hljs-comment"># 0:左眼，1:右眼，2:双眼</span><br>adb shell setprop debug.oculus.capture.width 3840 <span class="hljs-comment"># 分辨率</span><br>adb shell setprop debug.oculus.capture.height 1920 <span class="hljs-comment"># 分辨率</span><br>adb shell setprop debug.oculus.fullRateCapture 0 <span class="hljs-comment"># 帧率</span><br>adb shell setprop debug.oculus.capture.bitrate 40000000 <span class="hljs-comment"># 码率</span><br></code></pre></td></tr></table></figure><h2 id="4-相机防抖设置"><a href="#4-相机防抖设置" class="headerlink" title="4. 相机防抖设置"></a>4. 相机防抖设置</h2><p>在设置&gt;系统&gt;相机&gt;图像稳定性调&gt;最高。</p><hr><p>这个录制视频，本质还是录制左右屏幕，录制完3D视频后，可以使用4XVR等播放器播放。缺陷例如图像清晰度不高或像素低，希望官方后续会发布真正3D录制功能。</p>]]></content>
      
      
      
        <tags>
            
            <tag> VR </tag>
            
            <tag> Quest3 </tag>
            
            <tag> 3D video </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>来装一台软路由</title>
      <link href="/2024/03/11/Build-a-Software-Router/"/>
      <url>/2024/03/11/Build-a-Software-Router/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>之前使用的小米BE7000路由器，最近觉得他的IPV6有些许卡顿，同时想升级一下40G内网，12口的SX6036又觉得有些大且用不上12口，所以决定自己装一台软路由，折腾一下。</p><h2 id="硬件选择"><a href="#硬件选择" class="headerlink" title="硬件选择"></a>硬件选择</h2><p>在硬件选择之前，先明确一下需求：</p><ol><li>高速40G内网，双口即够用</li><li>正常使用的2.5G内网，5口或者更多</li><li>较低功耗</li><li>需要一颗核显来跑一些游戏模拟器之类的（我们粥批是这样的）</li></ol><h3 id="机箱"><a href="#机箱" class="headerlink" title="机箱"></a>机箱</h3><p>这样的需求下，我决定先选择机箱。我们需要一块HPE 544+的Mellanox网卡，所以需要一个全高插槽，主板至少要自带一个2.5G网口，这样只需要再买一张4口的2.5G网卡即可，diewu家有一张半高的。在一番搜寻下，在一个手工作坊的小店里找到了一个符合我奇怪需求的<a href="https://item.taobao.com/item.htm?id=628158610335">神奇机箱</a>，非常工业风，能通过延长线插一个全高和一个半高的PCI-E卡，直接拿下。<br><img src="/images/soft-router/case.jpg" alt="神奇机箱"></p><h3 id="主板"><a href="#主板" class="headerlink" title="主板"></a>主板</h3><p>由于有核显需求，只能选择Intel的平台（预算问题没考虑上AMD的Zen4或APU），所以要在H610&#x2F;B660&#x2F;B760平台中选择一块ITX的，带至少一个2.5G网口的主板。还是因为预算问题，最终在精粤和尔英这两家中做选择（我也想买御三家的，奈何没钱啊）。精粤多一个1G网口，但贵200，so，尔英赢了。注意，尔英的B760i有两个版本，一个是啥都没标的，一个是标ARGB的。虽然我这次用不到ARGB，但是前一个版本的散热盔甲设计有问题，会遮挡绝大多数的CPU散热器，且有南桥散热器会顶弯M.2硬盘的问题，所以还是选择了贵40的ARGB版本。<br><img src="/images/soft-router/mainboard.jpg" alt="尔英主板"></p><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>在预算与功耗的限制下，CPU貌似没得选，只能i3-12100了。至于为什么不选带T的低功耗版，因为我们粥批是这样的。</p><h3 id="电源"><a href="#电源" class="headerlink" title="电源"></a>电源</h3><p>这种体积的机箱，只能用DC-ATX电源。而且针对软路由这种24小时开机的设备，DC-ATX电源的转换率也相对较高一些。选了个160W的，稍微留了些余量，应该够用。<br><img src="/images/soft-router/powersupply.jpg" alt="DC-ATX电源"></p><h3 id="散热器"><a href="#散热器" class="headerlink" title="散热器"></a>散热器</h3><p>这个机箱的散热器只能用低一点的下压式散热器，一开始选择了ID-COOLING IS-40X，安装的时候发现47mm的太高了，会挡住全高的那张网卡，后来换成了利民的AXP90-X36，这个高度是36mm，但也会卡住一点点网卡，不过还是能用。</p><h3 id="网卡"><a href="#网卡" class="headerlink" title="网卡"></a>网卡</h3><p>40G内网需要双口，所以选择了HPE 544+，这卡由于是HPE的特殊接口的卡，所以巨便宜，算上转接板60块钱。这张卡支持RDMA，而且是ROCEv2，用在软路由上做软桥接也能正确配置，所以性价比非常高。<br><img src="/images/soft-router/hpe544.jpg" alt="HPE 544+"></p><p>2.5G网卡选择了diewu的4口2.5G网卡，8125芯片的，249块钱，这个不便宜，但他家的带一块巨大散热片，对稳定性有一定的保障。<br><img src="/images/soft-router/diewu4port.jpg" alt="diewu 4口2.5G"></p><p>大件（奇葩件）基本都确定了，浅列一下配置单：</p><table><thead><tr><th>配件</th><th>型号</th><th>到手价格</th></tr></thead><tbody><tr><td>CPU</td><td>i3-12100</td><td>599</td></tr><tr><td>主板</td><td>尔英B760i-ARGB</td><td>449</td></tr><tr><td>内存</td><td>光威天策3200C18 16G*2</td><td>364</td></tr><tr><td>硬盘</td><td>铠侠RC20 1T</td><td>抽屉里翻出来的</td></tr><tr><td>电源</td><td>DC-ATX 160W</td><td>95</td></tr><tr><td>机箱</td><td>神奇机箱</td><td>109</td></tr><tr><td>散热器</td><td>利民AXP90-X36</td><td>99</td></tr><tr><td>网卡1</td><td>HPE 544+</td><td>60</td></tr><tr><td>网卡2</td><td>diewu 4口2.5G</td><td>249</td></tr><tr><td>合计</td><td></td><td>2024</td></tr></tbody></table><p>总价居然和年份一样，这个价格还是贵了点，但如果选择前几代平台，可能会便宜一些，但功耗会高一些，所以还是选择了12100。</p><p><img src="/images/soft-router/hardware.jpg" alt="硬件进箱"></p><h2 id="软件系统"><a href="#软件系统" class="headerlink" title="软件系统"></a>软件系统</h2><p>因为我是粥批，所以选择了Windows Server 2022做宿主机系统，这样我可以直接用Winserver安装安卓模拟器来挂明日方舟，可以充分利用到核显（关于在Windows Server 2022上安装安卓模拟器的教程，可以参考我之前的文章<a href="/2024/03/01/winserver-android-hyperv/">在Windows Server 2022上安装安卓模拟器</a>）。然后用Hyper-V安装了iStoreOS作为软路由系统，并将所有网口都直通给iStoreOS（这里有坑）。</p><h3 id="网卡直通"><a href="#网卡直通" class="headerlink" title="网卡直通"></a>网卡直通</h3><p>利用这个<a href="https://github.com/chanket/DDA">工具</a>，可以在图形化界面上直通网卡给虚拟机，但由于这个工具并非官方工具，存在一些bug（也可能是微软DDA的bug），所以还是需要知道一下PowerShell的命令，以便在出现问题时能够手动操作。先到设备管理器中找到需要直通的网卡，右键属性，详细信息，找到“位置路径”这一项，复制那个PCIROOT开头的路径，这是你的网卡的位置路径。<br><img src="/images/soft-router/dda-path.jpg" alt="位置路径"><br>然后打开PowerShell，输入以下命令：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$a</span>=<span class="hljs-string">&quot;PCIROOT(x)#PCI(xxx)#PCI(xxx)&quot;</span> <span class="hljs-comment">#这里替换成你的位置路径</span><br><span class="hljs-built_in">Dismount-VMHostAssignableDevice</span> <span class="hljs-literal">-Force</span> <span class="hljs-literal">-LocationPath</span> <span class="hljs-variable">$a</span><br><span class="hljs-comment"># 这里可能会报错，说需要禁用网卡，那就禁用网卡，然后再执行上面的命令</span><br><span class="hljs-built_in">Add-VMAssignableDevice</span> <span class="hljs-literal">-LocationPath</span> <span class="hljs-variable">$a</span> <span class="hljs-literal">-VMName</span> iStoreOS<br><span class="hljs-comment"># iStoreOS是我的软路由虚拟机的名字，这里替换成你的虚拟机的名字</span><br></code></pre></td></tr></table></figure><p>这样理论上就已经将网卡直通给虚拟机了，但是在我的环境下，两张网卡各有各的坑。都是发生在当虚拟机开机的情况下，直接断电或者关闭宿主机，再次开机后，虚拟机无法启动，两张网卡都会报错。首先需要执行以下操作：</p><ol><li>打开Hyper-V管理器，找到虚拟机，右键设置，自动停止操作，选择“强制关闭虚拟机”。默认选择的是“保存虚拟机状态”，这样直通了网卡的虚拟机会去锁定网卡，导致宿主机无法使用网卡，而下一次开机时，锁定的网卡无法被虚拟机使用，循环上了。</li><li>打开powershell，把之前已经直通了的网卡取消直通，输入以下命令：</li></ol><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Remove-VMAssignableDevice</span> <span class="hljs-literal">-LocationPath</span> <span class="hljs-variable">$a</span> <span class="hljs-literal">-VMName</span> iStoreOS<br><span class="hljs-built_in">Mount-VMHostAssignableDevice</span> <span class="hljs-literal">-LocationPath</span> <span class="hljs-variable">$a</span><br></code></pre></td></tr></table></figure><ol start="3"><li>重启宿主机，再次直通网卡给虚拟机，这样理论上虚拟机就能正常启动了。但在我的环境下，步骤2就会报错，而且两张网卡的报错不一样。</li></ol><h4 id="HPE-544"><a href="#HPE-544" class="headerlink" title="HPE 544+"></a>HPE 544+</h4><p>这个卡会提示<code>在设备卸除期间，无法加载必需的虚拟化驱动程序pcip.sys</code>，这个问题我猜测是因为直通了网卡，关机保存状态时锁定了注册表中的某一项，导致下次设备卸除的时候，找不到pcip.sys这个驱动，所以无法加载。</p><p>解决方法：</p><ol><li>在设备管理器中找到这个网卡，右键属性，详细信息，找到“硬件ID”这一项，复制那个<code>PCI\VEN_xxxx&amp;DEV_xxxx</code>这个ID。</li><li>打开注册表，找到<code>\HKEY_LOCAL_MACHINE\SYSTEM\ControlSet001\Enum\PCIP\PCI\VEN_xxxx&amp;DEV_xxxx</code>这个路径，下面应该有你直通的网卡，我们需要全部删除，重新直通，让系统重新生成这些注册表项。</li><li>在删除时，可能会提示权限不足，这是因为注册表项被锁定了，需要一层一层的解锁，非常麻烦，之后如果再次出现这个问题，我会尝试使用写一个Python脚本来解决这个问题。</li><li>删除完注册表项后，重启宿主机，再次直通网卡给虚拟机，这样理论上虚拟机就能正常启动了。</li></ol><h4 id="Realtek-8125"><a href="#Realtek-8125" class="headerlink" title="Realtek 8125"></a>Realtek 8125</h4><p>这个卡会提示“无法找到PCI路径”之类的错误，我本以为是和HPE 544+一样的问题，在操作过之后也能解决。但在配置完“强制关闭虚拟机”后，再次开机，这个错误又出现了。然而如果只直通HPE 544+，不直通Realtek 8125，这个错误就不会出现。所以和HPE 544+的问题不一样。在一顿尝试之后，我发现只要在直通之前，把Realtek 8125的所有关于“wol唤醒”和“节能”之类的功能都关闭，这个错误就不会出现。</p><ol><li>打开设备管理器，找到Realtek 8125，右键属性，高级，找到“关机唤醒”，选择“关闭”；找到“环保节能”，选择“关闭”；找到“节能以太网路”，选择“关闭”。</li><li>点开“电源管理”，取消勾选“允许计算机关闭此设备以节约电源”，“允许此设备唤醒计算机”。</li><li>重启宿主机，再次直通网卡给虚拟机，这样在意外断电或者强制关闭虚拟机后，再次开机，这个错误就不会出现了。</li></ol><p><img src="/images/soft-router/rtl8125.jpg" alt="Realtek 8125设置"></p><h3 id="软路由系统"><a href="#软路由系统" class="headerlink" title="软路由系统"></a>软路由系统</h3><p>原本是想选择爱快的，想着爱快可能稳定一些，也可能会对大墙内的网络环境有些特殊优化，但在测试之后发现，爱快的局域网网口无法开启巨帧，没法把MTU改成9000，这样40G的网卡就没法发挥出最大的性能，在测速时，40G网卡的速度只有5Gbps左右（主要是Mellanox的ConnectX-3 Pro网卡自身卸载能力也有一定问题，卡也比较老了性能比较差，只能靠打开巨帧来提高性能）；而且爱快的IPV6在我的环境下也有一些问题，MSS钳制时常会失效，时不时的会出现网页无法打开的情况，所以最终还是选择了iStoreOS。</p><p>iStoreOS是一个基于OpenWRT的软路由系统，作者是Koolshare的一位大佬，这个系统的特点是插件丰富，想要的功能基本都有，而且基于OpenWRT的系统，自己也能动手编译一些插件，这样就能满足一些特殊的需求；之后如果有网卡升级的需求，自己也能动手编译内核模块，这样就能支持新的网卡。关于iStoreOS的安装，互联网上有很多教程，这里就不再赘述了。在iStoreOS上打开40G网口的巨帧后，测速能达到25Gbps左右，虽然还是没达标（猜测可能和测速端CPU有关，毕竟我这边的CPU是i3-12100），但已经比爱快好很多了，之后会测试一下两台WinServer2022之间打开RDMA之后的速度。</p><p>在iStoreOS上关于IPV6的PMTU问题，我也找到了<a href="https://www.right.com.cn/forum/thread-8347557-1-1.html">解决方法</a>，在防火墙中添加一条规则：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">iptables -t mangle -A POSTROUTING -p tcp --tcp-flags SYN,RST SYN -o pppoe-wan -j TCPMSS --clamp-mss-to-pmtu<br>ip6tables -t mangle -A POSTROUTING -p tcp --tcp-flags SYN,RST SYN -o pppoe-wan -j TCPMSS --clamp-mss-to-pmtu<br></code></pre></td></tr></table></figure><p>这两句防火墙规则是将具有SYN标志位设置（且不设置RST标志位）的TCP数据包，通过pppoe-wan接口发送时，自动调整MSS值，使之不大于路径MTU（PMTU），从而避免由于MTU限制导致的IP分片。这样就能解决PMTU的问题了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> 软路由 </tag>
            
            <tag> 装机 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决开启Passwall2后向日葵无法正常远程的问题</title>
      <link href="/2024/03/11/passwall2-sunlogin/"/>
      <url>/2024/03/11/passwall2-sunlogin/</url>
      
        <content type="html"><![CDATA[<p><b>2024-03-12 更新</b></p><p>将Passwall2更新到了1.26-1版本，现在不再需要下文步骤了，把节点类型改为Sing-Box即可。</p><p><img src="/images/singbox.jpg" alt="节点类型"></p><hr><p>最近在软路由上配置了Passwall2，发现向日葵无法正常远程，会弹出“未知远程设备”的提示。就算把<code>oray.net</code>和<code>oray.com</code>加入了直连规则，也无法解决问题。找到了一个相同问题的<a href="https://github.com/xiaorouji/openwrt-passwall2/issues/447">issue</a>，在高级设置中勾选“流量嗅探只供路由使用 (Xray)”即可。</p><p><img src="/images/passwall2-sunlogin-xrayconfig.png" alt="流量嗅探只供路由使用"></p><p>这个选项不勾选时，你会向VPS发送域名准备访问，经过两次转换，但VPS的DNS得到的目标IP更准更近，但向日葵的海外业务是需要开通向日葵全球会员的，所以会出现“未知远程设备”的提示。勾选后，在软路由上进行DNS解析，随后判断出是大陆IP，直接连接，不再向VPS发送域名请求。</p>]]></content>
      
      
      
        <tags>
            
            <tag> 软路由 </tag>
            
            <tag> Passwall2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在Windows Server 2022上安装Android模拟器</title>
      <link href="/2024/03/01/winserver-android-hyperv/"/>
      <url>/2024/03/01/winserver-android-hyperv/</url>
      
        <content type="html"><![CDATA[<p>由于需要在Windows Server 2022上挂一些游戏（我们粥批是这样的），需要安装一个Android模拟器。由于Hyper-V的存在，市面上主流的模拟器都会报错，有报缺少VT-D的，有直接说无法启动的，也有让我关闭Hyper-V的。但是我又需要Hyper-V来跑一些虚拟机，所以不能关闭。</p><p>其实在Windows10上，hyper-v和模拟器是可以共存的，需要去功能中添加一个叫做“Windows Hypervisor Platform(Windows虚拟机监控程序平台)”的功能，就可以让安卓模拟器、以及VMware等虚拟机软件和Hyper-V共存。但是在Windows Server 2022上，在功能中找不到这个功能，需要使用PowerShell来安装。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs powershell">Dism /online /<span class="hljs-built_in">Enable-Feature</span> /FeatureName:HypervisorPlatform /All <span class="hljs-comment"># 安装Windows Hypervisor Platform</span><br><span class="hljs-comment"># 同时安装VirtualMachinePlatform与WSL 一次性重启解决</span><br>Dism /online /<span class="hljs-built_in">Enable-Feature</span> /FeatureName:VirtualMachinePlatform /All<br>Dism /online /<span class="hljs-built_in">Enable-Feature</span> /FeatureName:Microsoft<span class="hljs-literal">-Windows-Subsystem-Linux</span> /All<br></code></pre></td></tr></table></figure><p>随后重启，就可以在Windows Server 2022上安装Android模拟器了。我选择了传说中最流畅的<a href="https://mumu.163.com/">MuMu模拟器</a>，下载后一路下一步安装即可，过程中并没有报错，问题解决。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows </tag>
            
            <tag> Android </tag>
            
            <tag> Hyper-V </tag>
            
            <tag> 明日方舟 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>排查Mellanox ConnectX-3 Pro 在Windows下无法启动RDMA的问题</title>
      <link href="/2024/02/29/mellanox-win-rocev2/"/>
      <url>/2024/02/29/mellanox-win-rocev2/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近在安装了Mellanox ConnectX-3 Pro的网卡，想要使用RDMA来加速网络传输，但是在安装好驱动后，发现SMB无法启动RDMA。在网上找了一圈，也没有找到解决方案，最后自己摸索了一下，终于解决了这个问题，就此记录一下。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>为了最简单地启用RDMA，我两端都使用了Windows系统，客户端是Windows 10 22H2，服务端是Windows Server 2022。两端都使用了Mellanox ConnectX-3 Pro 40G网卡。通过软路由连接，题外话，软路由的软交换是能够支持RDMA的，这里我使用的软路由系统是iKuai。两端配置如下：</p><p>客户端：</p><ul><li>Windows 10 22H2</li><li>Ryzen 9 7950X</li><li>Mellanox ConnectX-3 Pro 40G网卡</li></ul><p>服务端：</p><ul><li>Windows Server 2022</li><li>Xeon E5-2640 v4</li><li>Mellanox ConnectX-3 Pro 40G网卡</li></ul><h2 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h2><p>首先，我们需要确认网卡的驱动是否安装正确。在设备管理器中，我们可以看到Mellanox ConnectX-3 Pro网卡的驱动已经安装成功。通过<code>Get-NetAdapter</code>命令，我们可以看到网卡的详细信息，包括网卡的名字、状态、MAC地址等。通过<code>Get-NetAdapterRDMA</code>命令，我们可以看到网卡是否支持RDMA，以及RDMA是否已经启用。在我的环境中，服务端的RDMA是已经启用的，但是客户端的RDMA是没有启用的，所以需要排查客户端的问题。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\&gt;<span class="hljs-built_in">Get-NetAdapterRDMA</span><br>Name                      InterfaceDescription                     Enabled     PFC        ETS       <br><span class="hljs-literal">----</span>                      <span class="hljs-literal">--------------------</span>                     <span class="hljs-literal">-------</span>     <span class="hljs-literal">---</span>        <span class="hljs-literal">---</span><br>以太网 <span class="hljs-number">13</span>                 HP InfiniBand FDR/Ethernet <span class="hljs-number">10</span>Gb/<span class="hljs-number">40</span>Gb ...  False        False      False<br>以太网 <span class="hljs-number">14</span>                 HP InfiniBand FDR/Ethernet <span class="hljs-number">10</span>Gb/<span class="hljs-number">40</span>Gb ...  False        False      False<br><span class="hljs-built_in">PS</span> C:\&gt;<br><span class="hljs-built_in">PS</span> C:\&gt;<span class="hljs-built_in">Get-SmbServerNetworkInterface</span><br>Interface Index RSS Capable RDMA Capable Speed    IpAddresses<br><span class="hljs-literal">---------------</span> <span class="hljs-literal">-----------</span> <span class="hljs-literal">------------</span> <span class="hljs-literal">-----</span>    <span class="hljs-literal">-----------</span><br><span class="hljs-number">12</span>              True        False         <span class="hljs-number">40</span> Gbps  &#123;...&#125;<br>...<br></code></pre></td></tr></table></figure><p>通过<code>Get-MlnxDriverCoreSetting</code>命令，可以查看ConnectX-3 Pro网卡的驱动设置，包括RoCE版本、网卡的状态等。我们需要使用RoCEv2，所以需要确认RoCEv2是否已经启用。在我的环境中，客户端的RoCEv2是没有启用的，找到问题所在了。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\&gt;<span class="hljs-built_in">Get-MlnxDriverCoreSetting</span><br><br>Caption               : DriverCoreSettingData <span class="hljs-string">&#x27;mlx4_bus&#x27;</span><br>Description           : Mellanox Driver Option Settings<br>ElementName           : mlx4_bus<br>InstanceID            : mlx4_bus<br>Name                  : mlx4_bus<br>Source                : <span class="hljs-number">3</span><br>SystemName            : DESKTOP<span class="hljs-literal">-ONVNK2T</span><br>LogMttsPerSeg         : <span class="hljs-number">0</span><br>LogNumCq              : <span class="hljs-number">19</span><br>LogNumMac             : <span class="hljs-number">7</span><br>LogNumMcg             : <span class="hljs-number">4294967295</span><br>LogNumMpt             : <span class="hljs-number">19</span><br>LogNumMtt             : <span class="hljs-number">20</span><br>LogNumQp              : <span class="hljs-number">20</span><br>LogNumRdmaRc          : <span class="hljs-number">4</span><br>LogNumSrq             : <span class="hljs-number">16</span><br>LogNumVlan            : <span class="hljs-number">7</span><br>MaximumWorkingThreads : <span class="hljs-number">4294967295</span><br>RoceMode              : <span class="hljs-number">0</span><br>Set4kMtu              : True<br>SriovPort1NumVFs      :<br>SriovPort2NumVFs      :<br>SriovPortMode         :<br>PSComputerName        :<br></code></pre></td></tr></table></figure><p>可以看到，RoceMode是0，说明RoCE是没有启用的，我们需要将RoCEv2启用。通过<code>Set-MlnxDriverCoreSetting</code>命令，我们可以修改RoCEv2的设置。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\&gt;<span class="hljs-built_in">Set-MlnxDriverCoreSetting</span> <span class="hljs-literal">-RoceMode</span> <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>修改成功后，我们需要重启网卡，使设置生效。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\&gt;<span class="hljs-built_in">Restart-NetAdapter</span> <span class="hljs-literal">-Name</span> <span class="hljs-string">&quot;以太网 13&quot;</span><br></code></pre></td></tr></table></figure><p>重启成功后，我们再次查看RDMA的状态，可以看到RDMA已经启用了。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\&gt;<span class="hljs-built_in">Get-NetAdapterRDMA</span><br>Name                      InterfaceDescription                     Enabled     PFC        ETS<br><span class="hljs-literal">----</span>                      <span class="hljs-literal">--------------------</span>                     <span class="hljs-literal">-------</span>     <span class="hljs-literal">---</span>        <span class="hljs-literal">---</span><br>以太网 <span class="hljs-number">13</span>                 HP InfiniBand FDR/Ethernet <span class="hljs-number">10</span>Gb/<span class="hljs-number">40</span>Gb ...  True        False      False<br>以太网 <span class="hljs-number">14</span>                 HP InfiniBand FDR/Ethernet <span class="hljs-number">10</span>Gb/<span class="hljs-number">40</span>Gb ...  True       False      False<br></code></pre></td></tr></table></figure><p>检查SMB的RDMA状态，可以看到客户端SMB的RDMA也已经启用了。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">PS</span> C:\&gt;<span class="hljs-built_in">Get-SmbClientNetworkInterface</span><br>Interface Index RSS Capable RDMA Capable Speed    IpAddresses<br><span class="hljs-literal">---------------</span> <span class="hljs-literal">-----------</span> <span class="hljs-literal">------------</span> <span class="hljs-literal">-----</span>    <span class="hljs-literal">-----------</span><br><span class="hljs-number">12</span>              True        True         <span class="hljs-number">40</span> Gbps  &#123;...&#125;<br>...<br></code></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Mellanox </tag>
            
            <tag> RDMA </tag>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录一次光猫崩溃</title>
      <link href="/2024/02/29/zte-modem-crash/"/>
      <url>/2024/02/29/zte-modem-crash/</url>
      
        <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>2024年2月27日，上海电信对中兴光猫G7615进行推送升级，版本变为V2.0.0P2T3。笔者是自己购买的光猫，不是电信给的，所有参数都是自己设置的，无法通过电信自动下发。在自动更新后，疑似是电信自动下发的配置文件导致光猫崩溃，先是IPTV无法使用，在光猫重启后，无法上网。同时光猫的管理员密码被电信的TR069协议修改，通过Web页面只能登陆普通用户，没有管理员权限，无法配置参数。联系运维小哥，被告知只能换回SDN光猫，无法桥接，无法使用自己的路由器来拨号。遂折腾了一天，重新配置，终于恢复如初，就此记录一下折腾的过程。<br><img src="/images/zte-modem/autoupdate.png" alt="光猫被自动升级了"></p><h2 id="重置光猫"><a href="#重置光猫" class="headerlink" title="重置光猫"></a>重置光猫</h2><p class="note note-danger" style="font-weight: bold;  font-size: 18px;">先拔掉光纤！先拔掉光纤！先拔掉光纤！</p><!-- # **<span style="color:red;">先拔掉光纤！先拔掉光纤！先拔掉光纤！</span>** --><p>重要的事情说三遍！如果不拔掉光纤，光猫会自动通过电信的TR069协议改管理员密码。进不了光猫后台就什么都干不了！</p><ol><li>拔掉光纤，用卡针长按光猫背面的Reset键15-30秒，等待光猫的所有指示灯都亮起，然后松开Reset键。</li><li>用一根网线连接光猫和电脑，由于光猫重置后，DHCP服务不一定会开启，所以需要手动设置电脑的IP地址为<code>192.168.1.2</code>，使用浏览器访问<code>192.168.1.1</code>，输入用户名<code>telecomadmin</code>和密码<code>nE7jA%5m</code>，进入光猫的管理页面。</li><li>需要折腾的话，还需要打开光猫的telnet，但经过实测，V2.0.0P2T3版本的光猫已经无法通过开源工具解锁telnet，所以我们需要先降级光猫的固件。这里我使用的是恩山找到的<code>V2.0.0P1N15E</code>版本的相对较老的固件，原帖子在<a href="https://www.right.com.cn/forum/thread-8310054-1-2.html">这里</a>，在我的仓库也可以<a href="https://github.com/FrankGu0911/zte_modem_tools/blob/main/firmware/G7615_CT_V2.0.0P1N15E_20230812_UPGRADE_BOOTLDR_ALL.bin">下载</a>，保证可以解锁telnet。（降级一定要确定硬件版本，选择合适自己得版本降级）</li></ol><p class="note note-danger" style="font-weight: bold;  font-size: 18px;">!!注意，只适用于G7615电信原版，联通版等手动刷了电信分区的机器切勿尝试，会砖，会砖，会砖!!</p><ol start="4"><li>寻找一番发现，光猫的固件升级页面是隐藏的，需要在地址栏输入<code>http://192.168.1.1:8080/login.cgi?username=telecomadmin&amp;psd=nE7jA%255m&amp;hidden=upgrade</code>，然后点击管理-&gt;设备管理-&gt;软件版本升级，上传bin升级。</li><li>降级成功后，自动重启，重新登录管理页面，此时硬件版本显示：V1.3.0 软件版本：V2.0.0P1T1下面就开始开启telnet来折腾。</li></ol><h2 id="开启telnet"><a href="#开启telnet" class="headerlink" title="开启telnet"></a>开启telnet</h2><p>老版本的固件可以通过两款开源工具来解锁telnet：</p><ol><li>来自<a href="https://www.right.com.cn/forum/space-uid-273987.html">mayi5147</a>：<a href="https://github.com/douniwan5788/zte_modem_tools">https://github.com/douniwan5788/zte_modem_tools</a></li><li>来自<a href="https://www.right.com.cn/forum/space-uid-294565.html">thank243</a>：<a href="https://github.com/thank243/zteOnu">https://github.com/thank243/zteOnu</a></li></ol><p>这里我使用的是第一款工具，需要Python3环境，按照README的说明，先安装依赖：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">conda create -n zte python=3.8<br>conda activate zte<br>pip install -r requirements.txt<br></code></pre></td></tr></table></figure><p>我使用的是电信版固件，默认管理员用户名与密码是<code>telecomadmin</code>和<code>nE7jA%5m</code>，所以运行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 zte_factroymode.py --user telecomadmin --pass nE7jA%5m --ip 192.168.1.1 --port 8080 telnet open<br></code></pre></td></tr></table></figure><p><img src="/images/zte-modem/zte-telnetopen.png" alt="使用开源工具解锁Telnet"></p><p>运行成功后，光猫的telnet就被打开了，同时会给一个telnet的用户名和密码，记得赶紧操作，十几分钟半个小时后，用户名和密码就会换。</p><p>Windows下可以使用putty连接telnet，或者在系统功能中安装Telnet，安装过程不再赘述。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">telnet 192.168.1.1<br></code></pre></td></tr></table></figure><p><img src="/images/zte-modem/telnet-con.png" alt="Telnet登陆"></p><h2 id="固化Telnet"><a href="#固化Telnet" class="headerlink" title="固化Telnet"></a>固化Telnet</h2><p>光猫重启后，telnet就会被关闭，所以我们需要固化telnet：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs bash">sendcmd 1 DB p TelnetCfg    <span class="hljs-comment">#查看telnet配置</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> TelnetCfg 0 Lan_Enable 1   <span class="hljs-comment">#开启lan口telnet</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> TelnetCfg 0 TS_UName root    <span class="hljs-comment">#设置telnet用户名</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> TelnetCfg 0 TSLan_UName root    <span class="hljs-comment">#设置lan口下telnet用户名</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> TelnetCfg 0 TS_UPwd Zte521   <span class="hljs-comment">#设置telnet密码</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> TelnetCfg 0 TSLan_UPwd Zte521   <span class="hljs-comment">#设置lan口下telnet密码</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> TelnetCfg 0 Max_Con_Num 99   <span class="hljs-comment">#设置最大连接数</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> TelnetCfg 0 ExitTime 999999    <span class="hljs-comment">#设置退出时间</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> TelnetCfg 0 InitSecLvl 3   <span class="hljs-comment">#设置初始安全级别</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> TelnetCfg 0 CloseServerTime 9999999    <span class="hljs-comment">#设置关闭telnet时间</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> TelnetCfg 0 Lan_EnableAfterOlt 1   <span class="hljs-comment">#设置olt下lan口telnet开关</span><br>sendcmd 1 DB save   <span class="hljs-comment">#保存配置</span><br></code></pre></td></tr></table></figure><h2 id="删除万恶的TR069"><a href="#删除万恶的TR069" class="headerlink" title="删除万恶的TR069"></a>删除万恶的TR069</h2><p>一旦光猫连上光纤，电信就会通过TR069协议修改光猫的管理员密码，所以我们需要删除TR069：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">sendcmd 1 DB p MgtServer   <span class="hljs-comment">#查看MgtServer配置</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> MgtServer 0 URL http://127.0.0.1   <span class="hljs-comment">#将TR069服务器地址改为本地</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> MgtServer 0 Tr069Enable 0  <span class="hljs-comment">#关闭TR069</span><br>sendcmd 1 DB save<br></code></pre></td></tr></table></figure><p>同时，如果不用电话，建议直接删除管理+语音连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sendcmd 1 DB p WANC<br>sendcmd 1 DB delr WANC 0<br>sendcmd 1 DB save<br></code></pre></td></tr></table></figure><p>通过以上步骤，得到一个已注册但没有配置任何连接的光猫。再更改下管理员用户名和密码。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sendcmd 1 DB <span class="hljs-built_in">set</span> DevAuthInfo 0 User XXXXXX  <span class="hljs-comment">#修改超级用户名</span><br>sendcmd 1 DB <span class="hljs-built_in">set</span> DevAuthInfo 0 Pass XXXXXX  <span class="hljs-comment">#修改超级密码</span><br>sendcmd 1 DB save<br></code></pre></td></tr></table></figure><h2 id="解决DNS劫持"><a href="#解决DNS劫持" class="headerlink" title="解决DNS劫持"></a>解决DNS劫持</h2><p>电信固件和联通固件部分省份没注册ITMS服务器的话会劫持所有DNS请求的结果到192.168.1.1，使用如下命令手动欺骗ITMS注册结果，解决刷完后打开任意网页自动跳转LOID注册页面。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">sendcmd 1 DB <span class="hljs-built_in">set</span> PDTCTUSERINFO 0 Status 0<br>sendcmd 1 DB <span class="hljs-built_in">set</span> PDTCTUSERINFO 0 Result 1<br>sendcmd 1 DB save<br></code></pre></td></tr></table></figure><p>重启光猫后，就可以使用新的管理员用户名和密码登录光猫的管理页面了。</p><h2 id="上海电信光猫配置"><a href="#上海电信光猫配置" class="headerlink" title="上海电信光猫配置"></a>上海电信光猫配置</h2><p>先去管理中填入Loid，笔者这里是需要桥接网络，并且IPTV仍然接在光猫上，配置网络：</p><p><img src="/images/zte-modem/network.png" alt="网络设置"></p><p>然后是IPTV：</p><p><img src="/images/zte-modem/iptv.png" alt="IPTV设置"><br><img src="/images/zte-modem/vlan-iptv.png" alt="IPTV的Vlan设置"><br><img src="/images/zte-modem/lan.png" alt="别动DNS来源"></p><p>看直播频道会卡住的话，需要配置一下组播IGMP：</p><p><img src="/images/zte-modem/igmp.png" alt="组播IGMP设置"></p><p>至此，光猫的配置就完成了，可以拔掉网线，接上光纤，连接路由器，就可以正常上网，看IPTV了。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>目前电信的光猫固件版本是V2.0.0P2T3，已经无法通过开源工具解锁telnet，所以只能通过降级固件来解锁telnet。还好没有堵上光猫固件降级的隐藏开关，不然可能要拆机用TTL刷机了。在此感谢恩山的大佬们，感谢开源工具的作者们，在此记录一下折腾的过程，以备后用（希望不会用到），希望对大家有所帮助。</p>]]></content>
      
      
      
        <tags>
            
            <tag> 网络 </tag>
            
            <tag> 光猫 </tag>
            
            <tag> 电信 </tag>
            
            <tag> TR069 </tag>
            
            <tag> Telnet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录一次Hexo的搭建与部署</title>
      <link href="/2024/02/28/Hexo-build/"/>
      <url>/2024/02/28/Hexo-build/</url>
      
        <content type="html"><![CDATA[<p>本教程使用GitHub自带的GitHub pages来生成静态个人博客，而Hexo可以更换各种好看的主题，而且都是免费的，花一点时间就可以打造出自己独有的个人博客。</p><p>Hexo这个有力的工具可以让我们专注于写出一篇博客而不需要关心如何编写html和CSS，再如何形成一个网站，它可以根据markdown文档和指定的主题直接生成一个静态网站，对于新手朋友或者不是专门搞前端开发的人们非常友好。</p><p>还有一个优点就是GitHub pages生成的网站很稳定，就算自己的本地站点被删除，也完全不影响已经发布到GitHub仓库的文章，依旧可以访问查看。</p><h2 id="部署环境"><a href="#部署环境" class="headerlink" title="部署环境"></a>部署环境</h2><h3 id="1-安装git和node-js"><a href="#1-安装git和node-js" class="headerlink" title="1. 安装git和node.js"></a>1. 安装git和node.js</h3><p>首先我们需要在本地安装git和node.js，因为Hexo基于node.js，再生成一个ssh密钥用于连接GitHub仓库以及本地文件夹。</p><ul><li>git下载链接：<a href="https://git-scm.com/">Git - Downloading Package</a></li><li>node.js下载链接：<a href="https://nodejs.org/">Node.js</a></li></ul><p>安装时可以直接一路点下一步，按默认设置安装即可。<br>想要验证安装是否成功，可以win+r输入cmd进入终端，并如下验证，如果出现版本号说明安装成功。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">git --version <span class="hljs-comment"># 查看git版本</span><br>node -v <span class="hljs-comment"># 查看node版本</span><br>npm -v <span class="hljs-comment"># 查看npm版本</span><br></code></pre></td></tr></table></figure><h3 id="2-连接GitHub"><a href="#2-连接GitHub" class="headerlink" title="2. 连接GitHub"></a>2. 连接GitHub</h3><p>在本地终端输入以下命令，设置用户名和邮箱：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">git config --global user.name <span class="hljs-string">&quot;GitHub用户名&quot;</span><br>git config --global user.email <span class="hljs-string">&quot;GitHub邮箱&quot;</span><br></code></pre></td></tr></table></figure><p>然后创建一个ssh密钥：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh-keygen -t rsa -C <span class="hljs-string">&quot;GitHub邮箱&quot;</span><br></code></pre></td></tr></table></figure><p>最后返回密钥结果和图片说明创建完成。</p><pre><code class="hljs">Enter passphrase (empty for no passphrase):Enter same passphrase again:Your identification has been saved in C:\xxx\xxx/.ssh/id_rsa.    Your public key has been saved in C:\xxx\xxx/.ssh/id_rsa.pub.    The key fingerprint is:SHA256:xxxThe key&#39;s randomart image is:+---[RSA 3072]----+|       +=+=+.++oo||       .oB  +.+=o||      . o .. +.oo||     o .    = oo.||      o S  + = =+||         +o + O o||          .+ + . ||          . . +  ||           . . .E|+----[SHA256]-----+</code></pre><p>找到路径Your public key has been saved in C:\xxx\xxx&#x2F;.ssh&#x2F;id_rsa.pub，打开id_rsa.pub文件，复制里面的内容。</p><p>登录GitHub，点击右上角自己的头像 - setting，找到SSH and GPG keys，点击New SSH key：<br><img src="/images/GitHub%E6%B7%BB%E5%8A%A0sshkey.png" alt="GitHub添加ssh key"><br>检测是否连接成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ssh git@github.com<br></code></pre></td></tr></table></figure><p>如果出现以下信息说明连接成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Hi xxx! You<span class="hljs-string">&#x27;ve successfully authenticated,...</span><br></code></pre></td></tr></table></figure><h2 id="Hexo搭建"><a href="#Hexo搭建" class="headerlink" title="Hexo搭建"></a>Hexo搭建</h2><p>关于详细安装步骤，可查看Hexo官网：<a href="https://hexo.io/zh-cn/docs/">Hexo - A fast, simple &amp; powerful blog framework</a>，这里只是简单的记录一下。</p><p>使用 npm 安装 Hexo：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install -g hexo-cli<br></code></pre></td></tr></table></figure><p>输入hexo -v即可查看是否安装成功。</p><p>新建一个hexo站点根目录，在这个目录下执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo init blog<br><span class="hljs-built_in">cd</span> blog<br>npm install<br></code></pre></td></tr></table></figure><p>完成后再执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hexo g<br>hexo s<br></code></pre></td></tr></table></figure><p>访问<code>http://localhost:4000</code>，即可浏览生成的hexo页面。</p><h2 id="部署到GitHub"><a href="#部署到GitHub" class="headerlink" title="部署到GitHub"></a>部署到GitHub</h2><h3 id="1-创建GitHub仓库"><a href="#1-创建GitHub仓库" class="headerlink" title="1. 创建GitHub仓库"></a>1. 创建GitHub仓库</h3><p>登录GitHub，点击右上角加号 - New repository，填写Repository name，点击Create repository。注意，如果想要部署到<code>username.github.io</code>，那么Repository name必须是username.github.io，username是你的GitHub用户名。不然就会部署到<code>username.github.io/Repository name</code>。<br><img src="/images/GitHub%E5%88%9B%E5%BB%BA%E4%BB%93%E5%BA%93.png" alt="GitHub创建仓库"></p><p>在新建的仓库中找到Settings - Pages，在Branch选择master，点击Save。<br><img src="/images/GitHub%E8%AE%BE%E7%BD%AEPages.png" alt="GitHub设置Pages"></p><h3 id="2-安装插件并部署到GitHub"><a href="#2-安装插件并部署到GitHub" class="headerlink" title="2. 安装插件并部署到GitHub"></a>2. 安装插件并部署到GitHub</h3><p>在hexo站点根目录下安装hexo-deployer-git插件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install hexo-deployer-git --save<br></code></pre></td></tr></table></figure><p>修改站点根目录下的_config.yml文件，找到deploy部分，修改为如下内容：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">deploy:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">git</span><br>  <span class="hljs-attr">repo:</span> <span class="hljs-string">https://github.com/xxx/xxx.github.io.git</span><br>  <span class="hljs-attr">branch:</span> <span class="hljs-string">master</span><br></code></pre></td></tr></table></figure><p>其中repo填写自己的GitHub仓库地址，branch填写master。</p><p>不出意外的话，现在就可以在<code>xxx.github.io</code>访问到自己的博客了，至此，Hexo的搭建与部署就完成了。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Hexo </tag>
            
            <tag> Blog </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
